<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Status Report Tool - Spreadsheet Simplicity</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
             <a href="#" class="flex items-center space-x-2">
                <span class="text-2xl font-bold text-gray-900">Spreadsheet Simplicity</span>
            </a>
            <nav id="main-nav" class="hidden md:flex items-center space-x-8">
                <a href="#" class="text-indigo-600 font-bold">Claim Status Report Tool</a>
            </nav>
        </div>
    </header>

    <main id="tool-content" class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Unified Claim Status Report Tool</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">
                    Select a client, upload today's report, and optionally add yesterday's report for comparison.
                </p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8 space-y-8">
                
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">1. Select Client</h2>
                    <select id="client-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Choose a Client --</option>
                        <option value="solis">SOLIS</option>
                        <option value="liberty">LIBERTY</option>
                        <option value="secur">SECUR</option>
                        <option value="csh">CSH</option>
                    </select>
                </div>

                <div id="configuration-container" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-t pt-8">2. Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label id="cleanAgeCol-label" for="cleanAgeCol">Clean Age:</label><input type="text" id="cleanAgeCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimStatusCol">Claim State:</label><input type="text" id="claimStatusCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimNumberCol">Claim Number:</label><input type="text" id="claimNumberCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="payerCol">Payer:</label><input type="text" id="payerCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="networkStatusCol">Network Status (Par/Non-Par):</label><input type="text" id="networkStatusCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="dsnpCol">DSNP Status:</label><input type="text" id="dsnpCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimTypeCol">Claim Type:</label><input type="text" id="claimTypeCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="totalChargesCol">Total Charges:</label><input type="text" id="totalChargesCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="notesCol">W9/Notes Column:</label><input type="text" id="notesCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div class="md:col-span-3"><label for="dateCols">Date Columns:</label><input type="text" id="dateCols" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                    </div>
                </div>
                
                <div id="upload-container" class="hidden">
                    <div class="border-t pt-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">3. Upload Reports</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="fileInput" class="block text-lg font-semibold text-gray-800 mb-2">Today's Main Report (Required):</label>
                                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="fileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                            <div>
                                <label for="yesterdayFileInput" class="block text-lg font-semibold text-gray-800 mb-2">Yesterday's Report (Optional):</label>
                                <input type="file" id="yesterdayFileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="yesterdayFileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <button id="processBtn" disabled class="bg-indigo-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Process Reports</button>
                        </div>

                        <div id="status" class="text-center mt-4 font-semibold h-6"></div>
                        <div id="loader"></div>
                        <div class="text-center mt-4 space-x-4">
                            <a href="#" id="downloadLink" class="hidden inline-block bg-green-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-green-700">Download Report</a>
                            <button id="copyEmailBtn" class="hidden inline-block bg-blue-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-blue-700">Copy Email Text</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        let processedReportData = null; 
        
        function initializeTool() {
            const clientSelect = document.getElementById('client-select');
            const configContainer = document.getElementById('configuration-container');
            const uploadContainer = document.getElementById('upload-container');
            const fileInput = document.getElementById('fileInput');
            const yesterdayFileInput = document.getElementById('yesterdayFileInput');
            const processBtn = document.getElementById('processBtn');

            const clientPresets = {
                solis: { label: 'Clean Age (Q):', cleanAgeCol: 'Q', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'F', dsnpCol: 'X', claimTypeCol: 'B', totalChargesCol: 'S', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                liberty: { label: 'Age (R):', cleanAgeCol: 'R', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'F', dsnpCol: 'Y', claimTypeCol: 'B', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                secur: { label: 'Clean Age (Q):', cleanAgeCol: 'Q', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'F', dsnpCol: 'Y', claimTypeCol: 'D', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                csh: { label: 'Age (R):', cleanAgeCol: 'R', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'F', dsnpCol: 'Y', claimTypeCol: 'B', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' }
            };

            clientSelect.addEventListener('change', () => {
                const selectedClient = clientSelect.value;
                if (selectedClient) {
                    const preset = clientPresets[selectedClient];
                    document.getElementById('cleanAgeCol-label').textContent = preset.label;
                    Object.keys(preset).forEach(key => {
                        if (key !== 'label') {
                            const element = document.getElementById(key);
                            if (element) element.value = preset[key];
                        }
                    });
                    configContainer.classList.remove('hidden');
                    uploadContainer.classList.remove('hidden');
                } else {
                    configContainer.classList.add('hidden');
                    uploadContainer.classList.add('hidden');
                }
            });
            
            const checkFiles = () => {
                const mainFile = fileInput.files[0];
                document.getElementById('fileName').textContent = mainFile ? `Selected: ${mainFile.name}` : 'No file selected';
                document.getElementById('yesterdayFileName').textContent = yesterdayFileInput.files[0] ? `Selected: ${yesterdayFileInput.files[0].name}` : 'No file selected';
                processBtn.disabled = !mainFile;
            };

            fileInput.addEventListener('change', checkFiles);
            yesterdayFileInput.addEventListener('change', checkFiles);
            
            processBtn.addEventListener('click', () => {
                if (fileInput.files[0] && gatherConfig()) {
                    processFiles(fileInput.files[0], yesterdayFileInput.files[0], gatherConfig());
                }
            });
            
            document.getElementById('copyEmailBtn').addEventListener('click', copyEmailText);
        }
        
        function gatherConfig() {
            try {
                const colLetterToIndex = (letter) => {
                    if (!letter || typeof letter !== 'string' || !/^[A-Z]+$/i.test(letter)) return -1;
                    let col = 0; letter = letter.toUpperCase();
                    for (let i = 0; i < letter.length; i++) col += (letter.charCodeAt(i) - 64) * Math.pow(26, letter.length - i - 1);
                    return col - 1;
                };
                const config = {};
                const ids = ['cleanAge', 'claimStatus', 'claimNumber', 'payer', 'networkStatus', 'dsnp', 'claimType', 'totalCharges', 'notes'];
                ids.forEach(id => config[`${id}Index`] = colLetterToIndex(document.getElementById(`${id}Col`).value));
                config.dateIndices = document.getElementById('dateCols').value.toUpperCase().trim().split(',').filter(c => c).map(c => colLetterToIndex(c.trim()));
                if (Object.values(config).some(val => val === -1 || (Array.isArray(val) && val.includes(-1)))) throw new Error("Invalid column letter entered.");
                return config;
            } catch (error) {
                displayStatus(`Configuration Error: ${error.message}`, 'error');
                return null;
            }
        }
        
        const parseCurrency = (value) => (value === null || value === undefined) ? NaN : parseFloat(String(value).replace(/[^0-9.-]/g, '')) || NaN;

        async function processFiles(mainFile, yesterdayFile, config) {
            displayStatus('Processing... Please wait.', 'info', true);
            const hasYesterdayReport = !!yesterdayFile;

            const readFileAsAOA = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null }));
                    } catch (err) { reject(new Error(`Failed to read ${file.name}: ${err.message}`)); }
                };
                reader.onerror = () => reject(new Error(`File reader error on ${file.name}`));
                reader.readAsArrayBuffer(file);
            });

            const getStatsForAOA = (aoa, config) => {
                const dayBuckets = { '0 - 10': 0, '11 - 20': 0, '21 - 29': 0, '30 - 59': 0, '60+': 0 };
                const stats = { 'PEND': { total: 0, ...dayBuckets }, 'ONHOLD': { total: 0, ...dayBuckets }, 'MANAGEMENTREVIEW': { total: 0, ...dayBuckets }, 'HC MGMT REV': { total: 0, ...dayBuckets }, 'W9_LETTER_NEEDED': { total: 0, ...dayBuckets }, 'W9_FOLLOW_UP': { total: 0, ...dayBuckets } };
                
                for(const row of aoa.slice(1)) {
                    if (row.every(cell => cell === null)) continue;
                    let claimState = String(row[config.claimStatusIndex] || '').trim().toUpperCase();
                    if (claimState === 'PREBATCH') continue;
                    const totalCharges = parseCurrency(row[config.totalChargesIndex]);
                    const claimType = String(row[config.claimTypeIndex] || '').trim().toUpperCase();
                    const cleanAge = parseInt(row[config.cleanAgeIndex], 10);
                    const daysValue = !isNaN(cleanAge) ? (cleanAge <= 10 ? '0 - 10' : (cleanAge <= 20 ? '11 - 20' : (cleanAge <= 29 ? '21 - 29' : (cleanAge <= 59 ? '30 - 59' : '60+')))) : '';
                    let finalClaimState = claimState;
                    if (claimState === 'MANAGEMENTREVIEW' && !isNaN(totalCharges) && ((claimType.includes('PROFESSIONAL') && totalCharges > 3500) || (claimType.includes('INSTITUTIONAL') && totalCharges > 6500))) {
                        finalClaimState = 'HC MGMT REV';
                    }
                    if (stats[finalClaimState]) {
                        stats[finalClaimState].total++;
                        if (stats[finalClaimState][daysValue] !== undefined) stats[finalClaimState][daysValue]++;
                    }
                    const noteTextLower = String(row[config.notesIndex] || '').toLowerCase();
                    if (noteTextLower.includes('w9')) {
                        if (noteTextLower.includes('requested') || noteTextLower.includes('req') || noteTextLower.includes('due')) {
                           if (stats['W9_FOLLOW_UP'][daysValue] !== undefined) stats['W9_FOLLOW_UP'][daysValue]++;
                           stats['W9_FOLLOW_UP'].total++;
                        } else if (noteTextLower.includes('denied') || noteTextLower.includes('missing') || noteTextLower.includes('not on file') || noteTextLower.includes('not received')) {
                           if (stats['W9_LETTER_NEEDED'][daysValue] !== undefined) stats['W9_LETTER_NEEDED'][daysValue]++;
                           stats['W9_LETTER_NEEDED'].total++;
                        }
                    }
                }
                return stats;
            };

            try {
                const main_aoa = await readFileAsAOA(mainFile);
                if (main_aoa.length < 1) throw new Error("Main report is empty.");
                const todayStats = getStatsForAOA(main_aoa, config);
                let yesterdayStats = null, yesterdayDataMap = new Map();

                if (hasYesterdayReport) {
                    const yesterday_aoa = await readFileAsAOA(yesterdayFile);
                    yesterdayStats = getStatsForAOA(yesterday_aoa, config);
                    yesterday_aoa.slice(1).forEach(row => {
                        const claimNumber = row[config.claimNumberIndex];
                        if (claimNumber != null) {
                            yesterdayDataMap.set(String(claimNumber).trim(), {
                                state: String(row[config.claimStatusIndex] || '').trim().toUpperCase(),
                                type: String(row[config.claimTypeIndex] || '').trim().toUpperCase(),
                                charges: parseCurrency(row[config.totalChargesIndex])
                            });
                        }
                    });
                }
                
                processedReportData = { today: todayStats, yesterday: yesterdayStats };
                
                const masterSheetName = "All Processed Data", highDollarSheetName = "High Dollar - Pat & Shelley";
                const sheetsData = { [masterSheetName]: [], [highDollarSheetName]: [] };
                
                const headerRow = main_aoa[0], newHeader = [...headerRow];
                if (hasYesterdayReport) newHeader.splice(config.claimStatusIndex, 0, 'Yest. Claim State');
                let daysInsertIndex = config.cleanAgeIndex + 1;
                if (hasYesterdayReport && config.cleanAgeIndex >= config.claimStatusIndex) daysInsertIndex++; 
                newHeader.splice(daysInsertIndex, 0, 'Days');
                newHeader.push('Added (Owner)', 'Due Date');
                sheetsData[masterSheetName].push(newHeader);
                sheetsData[highDollarSheetName].push(newHeader);

                for (const originalRow of main_aoa.slice(1)) {
                    if (originalRow.every(cell => cell === null)) continue;
                    let claimState = String(originalRow[config.claimStatusIndex] || '').trim().toUpperCase();
                    if (claimState === 'PREBATCH') continue;
                    const newRow = [...originalRow];
                    
                    if (hasYesterdayReport) {
                        const claimNumber = String(originalRow[config.claimNumberIndex] || '').trim();
                        const yestData = yesterdayDataMap.get(claimNumber);
                        let yestStateForColumn = 'NEW';
                        if (yestData) {
                            yestStateForColumn = yestData.state;
                            if (yestData.state === 'MANAGEMENTREVIEW' && !isNaN(yestData.charges) && ((yestData.type.includes('PROFESSIONAL') && yestData.charges > 3500) || (yestData.type.includes('INSTITUTIONAL') && yestData.charges > 6500))) {
                                yestStateForColumn = 'HC MGMT REV';
                            }
                        }
                        newRow.splice(config.claimStatusIndex, 0, yestStateForColumn);
                    }
                    
                    const claimType = String(originalRow[config.claimTypeIndex] || '').trim().toUpperCase();
                    const totalCharges = parseCurrency(originalRow[config.totalChargesIndex]);
                    const isHighCost = claimState === 'MANAGEMENTREVIEW' && !isNaN(totalCharges) && ((claimType.includes('PROFESSIONAL') && totalCharges > 3500) || (claimType.includes('INSTITUTIONAL') && totalCharges > 6500));
                    const cleanAge = parseInt(originalRow[config.cleanAgeIndex], 10);
                    const daysValue = !isNaN(cleanAge) ? (cleanAge <= 10 ? '0 - 10' : (cleanAge <= 20 ? '11 - 20' : (cleanAge <= 29 ? '21 - 29' : (cleanAge <= 59 ? '30 - 59' : '60+')))) : '';
                    let ownerValue = '';

                    if (isHighCost) { 
                        ownerValue = 'Pat and Shelley';
                    } 
                    else if (['MANAGEMENTREVIEW', 'ONHOLD'].includes(claimState)) { ownerValue = 'Jessica'; } 
                    else if (['PEND', 'APPROVED', 'DENY'].includes(claimState)) { ownerValue = 'Patrick'; } 
                    else if (claimState === 'PR') { ownerValue = originalRow[config.payerIndex] || ''; }

                    newRow.splice(daysInsertIndex, 0, daysValue);
                    const noteText = String(originalRow[config.notesIndex] || '');
                    newRow.push(ownerValue, extractDueDateFromNote(noteText));
                    sheetsData[masterSheetName].push(newRow);

                    if (isHighCost) {
                        sheetsData[highDollarSheetName].push(newRow);
                    }
                    
                    if (!isHighCost && ['PEND', 'ONHOLD', 'MANAGEMENTREVIEW', 'DENY'].includes(claimState)) {
                        const networkStatusRaw = String(originalRow[config.networkStatusIndex] || '').toUpperCase();
                        let networkStatus = networkStatusRaw.includes('NON') ? 'NonPar' : 'Par';

                        const dsnpRaw = String(originalRow[config.dsnpIndex] || '').toUpperCase();
                        let dsnpStatus = '';
                        if (dsnpRaw.includes('NON DSNP')) { dsnpStatus = 'NonDSNP'; } 
                        else if (dsnpRaw.includes('DSNP') || dsnpRaw === 'Y') { dsnpStatus = 'DSNP'; }

                        let statusTab = '', tabOwner = '';
                        if (claimState === 'MANAGEMENTREVIEW') { statusTab = 'MgmtRev'; tabOwner = 'Jessica'; }
                        else if (claimState === 'ONHOLD') { statusTab = 'OnHold'; tabOwner = 'Jessica'; }
                        else if (claimState === 'PEND') { statusTab = 'Pend'; tabOwner = 'Patrick'; }
                        else if (claimState === 'DENY') { statusTab = 'Deny'; tabOwner = 'Patrick'; }

                        if (dsnpStatus && tabOwner && networkStatus) {
                            let tabKey = '';
                            
                            if (daysValue === '21 - 29') {
                                tabKey = truncateSheetName(`${tabOwner} - PRIORITY ${networkStatus} ${statusTab} ${dsnpStatus}`);
                            } 
                            else if (['0 - 10', '11 - 20'].includes(daysValue)) {
                                const ageTab = (daysValue === '0 - 10') ? '0-10d' : '11-20d';
                                tabKey = truncateSheetName(`${tabOwner} - Queue ${ageTab} ${networkStatus} ${statusTab} ${dsnpStatus}`);
                            }
                            else if (['30 - 59', '60+'].includes(daysValue)) {
                                const ageTab = (daysValue === '30 - 59') ? '30-59d' : '60+d';
                                tabKey = truncateSheetName(`${tabOwner} - Aged ${ageTab} ${networkStatus} ${statusTab} ${dsnpStatus}`);
                            }

                            if (tabKey) {
                                if (!sheetsData[tabKey]) sheetsData[tabKey] = [newHeader];
                                sheetsData[tabKey].push(newRow);
                            }
                        }
                    }

                    if (config.notesIndex >= 0 && noteText.toLowerCase().includes('w9')) {
                        let w9SheetName = '';
                        const noteLower = noteText.toLowerCase();
                        if (noteLower.includes('requested') || noteLower.includes('req') || noteLower.includes('due')) w9SheetName = 'W9 Follow-Up - Pat';
                        else if (noteLower.includes('denied') || noteLower.includes('missing') || noteLower.includes('not on file') || noteLower.includes('not received')) w9SheetName = 'W9 Letter Needed - Jess';
                        else if (noteLower.includes('received') || noteLower.includes('reprocess') || noteLower.includes('rerun')) w9SheetName = 'W9 Received - Reprocess';
                        if (w9SheetName) {
                            if (!sheetsData[w9SheetName]) sheetsData[w9SheetName] = [newHeader];
                            sheetsData[w9SheetName].push(newRow);
                        }
                    }
                }
                
                const newWorkbook = XLSX.utils.book_new();
                const sheetOrder = [masterSheetName, highDollarSheetName, ...Object.keys(sheetsData).filter(n => n.startsWith('W9 ')).sort(), ...Object.keys(sheetsData).filter(n => ![masterSheetName, highDollarSheetName].includes(n) && !n.startsWith('W9 ')).sort()];
                sheetOrder.forEach(sheetName => {
                    if (sheetsData[sheetName] && sheetsData[sheetName].length > 1) { 
                        const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                        ws['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(ws['!ref'])) };
                        XLSX.utils.book_append_sheet(newWorkbook, ws, sheetName);
                    }
                });
                const clientText = document.getElementById('client-select').options[document.getElementById('client-select').selectedIndex].text;
                document.getElementById('downloadLink').download = `${clientText} Daily Action Report for ${getFormattedDate()}.xlsx`;
                document.getElementById('downloadLink').href = URL.createObjectURL(new Blob([XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' })], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
                document.getElementById('downloadLink').classList.remove('hidden');
                document.getElementById('copyEmailBtn').classList.remove('hidden');
                displayStatus('Processing Complete!', 'success');
            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function getFormattedDate() {
            const d=new Date(), day=d.getDate(), month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()], year=d.getFullYear();
            const s = (day%10===1&&day!==11)?'st':((day%10===2&&day!==12)?'nd':((day%10===3&&day!==13)?'rd':'th'));
            return `${day}${s} ${month} ${year}`;
        }
        
        function extractDueDateFromNote(noteText) {
            const match = (noteText || '').match(/due\s*(by)?[:\s]*(\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i);
            return match ? match[2] : '';
        }

        function copyEmailText() {
            if (!processedReportData) return alert("Please process a report first.");
            const clientName = document.getElementById('client-select').options[document.getElementById('client-select').selectedIndex].text;
            const ageBasisText = document.getElementById('cleanAgeCol-label').textContent.replace(':', '');
            const { today, yesterday } = processedReportData;

            const combinedMgmtRevToday = { ...today['MANAGEMENTREVIEW'] };
            const hcToday = today['HC MGMT REV'];
            Object.keys(hcToday).forEach(key => {
                combinedMgmtRevToday[key] = (combinedMgmtRevToday[key] || 0) + hcToday[key];
            });

            let combinedMgmtRevYesterday = null;
            if (yesterday) {
                combinedMgmtRevYesterday = { ...yesterday['MANAGEMENTREVIEW'] };
                const hcYesterday = yesterday['HC MGMT REV'] || { total: 0, '0 - 10': 0, '11 - 20': 0, '21 - 29': 0, '30 - 59': 0, '60+': 0 };
                Object.keys(hcYesterday).forEach(key => {
                    combinedMgmtRevYesterday[key] = (combinedMgmtRevYesterday[key] || 0) + hcYesterday[key];
                });
            }

            const formatStatLine = (t, y) => yesterday ? `${t} (${y})` : `${t}`;
            
            const createStatBlock = (title, todayStats, yestStats) => {
                const y = yesterday ? yestStats : null;
                return `Number of total claims ${title}: ${formatStatLine(todayStats.total, y?.total ?? 0)}\n0 - 10 Days: ${formatStatLine(todayStats['0 - 10'], y?.['0 - 10'] ?? 0)}\n11 - 20 Days: ${formatStatLine(todayStats['11 - 20'], y?.['11 - 20'] ?? 0)}\n21 - 29 Days: ${formatStatLine(todayStats['21 - 29'], y?.['21 - 29'] ?? 0)}\n30 - 59 Days: ${formatStatLine(todayStats['30 - 59'], y?.['30 - 59'] ?? 0)}\n60+ Days: ${formatStatLine(todayStats['60+'], y?.['60+'] ?? 0)}`;
            };
            
            const yestCombined = yesterday ? combinedMgmtRevYesterday : null;
            const yestHc = yesterday ? yesterday['HC MGMT REV'] : null;
            const mgmtReviewBlock = `Number of total claims Management Review: ${formatStatLine(combinedMgmtRevToday.total, yestCombined?.total ?? 0)}\nOf these, High Dollar Claims: ${formatStatLine(today['HC MGMT REV'].total, yestHc?.total ?? 0)}\n0 - 10 Days: ${formatStatLine(combinedMgmtRevToday['0 - 10'], yestCombined?.['0 - 10'] ?? 0)}\n11 - 20 Days: ${formatStatLine(combinedMgmtRevToday['11 - 20'], yestCombined?.['11 - 20'] ?? 0)}\n21 - 29 Days: ${formatStatLine(combinedMgmtRevToday['21 - 29'], yestCombined?.['21 - 29'] ?? 0)}\n30 - 59 Days: ${formatStatLine(combinedMgmtRevToday['30 - 59'], yestCombined?.['30 - 59'] ?? 0)}\n60+ Days: ${formatStatLine(combinedMgmtRevToday['60+'], yestCombined?.['60+'] ?? 0)}`;

            const intro = yesterday ? `I have attached today's report for ${clientName}. Below are the highlights from this report, previous days are in (parenthesis):` : `I have attached today's report for ${clientName}. Below are the highlights from this report:`;
            
            const emailBody = `Hello Shelley, Jessica, and Pat,\n\n${intro}\n\n${createStatBlock('pending', today['PEND'], yesterday?.['PEND'])}\n\n${createStatBlock('On Hold', today['ONHOLD'], yesterday?.['ONHOLD'])}\n\n${mgmtReviewBlock}\n\n${createStatBlock('needing W9 Letter', today['W9_LETTER_NEEDED'], yesterday?.['W9_LETTER_NEEDED'])}\n\n${createStatBlock('for W9 Follow-Up', today['W9_FOLLOW_UP'], yesterday?.['W9_FOLLOW_UP'])}\n\nPlease let me know if you have any questions regarding this information.\n\nThis ${clientName} report is based on ${ageBasisText}.\n`;
            
            navigator.clipboard.writeText(emailBody).then(() => {
                const btn = document.getElementById('copyEmailBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 2000);
            }).catch(err => alert('Failed to copy text.'));
        }
        
        function displayStatus(message, type, showLoader = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : '#4f46e5');
            document.getElementById('loader').style.display = showLoader ? 'block' : 'none';
            document.getElementById('downloadLink').classList.toggle('hidden', type !== 'success');
            document.getElementById('copyEmailBtn').classList.toggle('hidden', type !== 'success');
        }

        const truncateSheetName = (name) => name.replace(/[\\\/\?\*\[\]]/g, '').substring(0, 31);
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initializeTool();
        });
    </script>
</body>
</html>
