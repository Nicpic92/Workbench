<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Status Report Tool - Spreadsheet Simplicity</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
             <a href="#" class="flex items-center space-x-2">
                <span class="text-2xl font-bold text-gray-900">Spreadsheet Simplicity</span>
            </a>
            <nav id="main-nav" class="hidden md:flex items-center space-x-8">
                <a href="#" class="text-indigo-600 font-bold">Claim Status Report Tool</a>
            </nav>
        </div>
    </header>

    <main id="tool-content" class="container mx-auto px-6 py-12">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Unified Claim Status Report Tool</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">
                    Select a client, upload today's report, and optionally add yesterday's report for comparison.
                </p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8 space-y-8">
                
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">1. Select Client</h2>
                    <select id="client-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Choose a Client --</option>
                        <option value="solis">SOLIS</option>
                        <option value="liberty">LIBERTY</option>
                        <option value="secur">SECUR (Sonder)</option>
                        <option value="csh">CSH</option>
                    </select>
                </div>

                <div id="configuration-container" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-t pt-8">2. Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label id="cleanAgeCol-label" for="cleanAgeCol">Clean Age:</label><input type="text" id="cleanAgeCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimStatusCol">Claim State:</label><input type="text" id="claimStatusCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimNumberCol">Claim Number:</label><input type="text" id="claimNumberCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="payerCol">Payer:</label><input type="text" id="payerCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="networkStatusCol">Network Status (Par/Non-Par):</label><input type="text" id="networkStatusCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="dsnpCol">DSNP Status:</label><input type="text" id="dsnpCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="claimTypeCol">Claim Type:</label><input type="text" id="claimTypeCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="totalChargesCol">Total Charges:</label><input type="text" id="totalChargesCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div><label for="notesCol">W9/Notes Column:</label><input type="text" id="notesCol" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                        <div class="md:col-span-3"><label for="dateCols">Date Columns:</label><input type="text" id="dateCols" class="mt-1 w-full p-2 border rounded-md uppercase"></div>
                    </div>
                </div>
                
                <div id="upload-container" class="hidden">
                    <div class="border-t pt-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">3. Upload Reports</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="fileInput" class="block text-lg font-semibold text-gray-800 mb-2">Today's Main Report (Required):</label>
                                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="fileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                            <div>
                                <label for="yesterdayFileInput" class="block text-lg font-semibold text-gray-800 mb-2">Yesterday's Report (Optional):</label>
                                <input type="file" id="yesterdayFileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="yesterdayFileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <button id="processBtn" disabled class="bg-indigo-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Process Reports</button>
                        </div>
                    </div>
                </div>
                
                <div id="status" class="text-center mt-4 font-semibold h-6"></div>
                <div id="loader"></div>
                
                <div id="review-container" class="hidden space-y-8 border-t pt-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900">4. Review & Finalize</h2>
                        <p class="mt-2 text-lg text-gray-600">Review assignments for un-coded notes and download reports.</p>
                    </div>

                    <div id="prebatch-container" class="hidden bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Prebatch Claims</h3>
                        <p id="prebatch-summary" class="text-gray-700 mb-4"></p>
                        <button id="downloadPrebatchBtn" class="bg-teal-600 text-white font-bold text-lg rounded-lg py-3 px-8 hover:bg-teal-700">Download Prebatch Report</button>
                    </div>

                    <div id="assignment-editor">
                        <h3 class="text-xl font-bold text-gray-900 mb-3">Assignment Editor (Exceptions Only)</h3>
                        <p id="assignment-editor-description" class="text-gray-700 mb-4"></p>
                        <div class="table-container border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200 table-fixed">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th scope="col" class="w-1/2 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note Text</th>
                                        <th scope="col" class="w-1/12 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                        <th scope="col" class="w-1/4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Default Assignment</th>
                                        <th scope="col" class="w-1/4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Assignment (Override)</th>
                                    </tr>
                                </thead>
                                <tbody id="assignment-editor-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="text-center pt-6">
                        <button id="generateFinalReportsBtn" class="bg-green-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-green-700">Generate Final Reports</button>
                    </div>
                </div>

                <div id="final-downloads-container" class="hidden text-center mt-4 space-y-4">
                    <div id="download-links-container" class="flex flex-wrap justify-center gap-4"></div>
                    <button id="copyEmailBtn" class="hidden inline-block bg-blue-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-blue-700">Copy Email Text</button>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        let processedClaimsList = [];
        let prebatchClaims = [];
        let fileHeaderRow = [];
        let mainReportHeader = [];
        let yesterdayDataMap = new Map();
        let yesterdayStats = null;
        let workflowMovement = { pvToClaims: 0, claimsToPv: 0 };
        let hasYesterdayFile = false;

        function getHardcodedAssignment(noteText) {
            const note = noteText || "";
            if (note === "No Note" || note === "") return null;
            const noteLower = note.toLowerCase();

            if (noteLower.includes('rachael notes') || noteLower.includes('rachael response') || noteLower.includes('as per rachael')) return 'PV';
            if (noteLower.includes('red tab')) return 'PV';
            if (noteLower.includes('hold for payer review')) return 'PV';
            if (noteLower.includes('no matching contract') || noteLower.includes('contract not found') || noteLower.includes('missing contract')) return 'PV';
            if (noteLower.includes('pay to name mismatch')) return 'PV';
            if (noteLower.includes('provider type not found') || noteLower.includes('no data for the rendering provider')) return 'PV';
            if (noteLower.includes('missing/incomplete/invalid pay-to')) return 'PV';
            if (noteLower.includes('w9 missing')) return 'PV';
            if (noteLower.includes('issue while getting contract')) return 'PV';
            
            if (noteLower.startsWith('error -')) return 'Claims';
            if (noteLower.startsWith('servicelineseq:')) return 'Claims';
            if (noteLower.includes('pv updated')) return 'Claims';
            if (noteLower.includes('remap')) return 'Claims';
            if (noteLower.includes('rerun')) return 'Claims';
            if (noteLower.includes('w9 req') || noteLower.includes('w9 requested')) return 'Claims';
            if (noteLower.includes('to be priced at')) return 'Claims';
            if (noteLower.includes('payment >') || noteLower.includes('net pay >') || noteLower.includes('>$10000') || noteLower.includes('exceeds total payment') || noteLower.includes('greater then 10k') || noteLower.includes('allowed amount 10k')) return 'Claims';
            if (noteLower.includes('no auth on file') || noteLower.includes('denied for authorization') || noteLower.includes('required authorization is not found')) return 'Claims';
            if (noteLower.includes('duplicate')) return 'Claims';
            if (noteLower.includes('pay-to-provider id updated')) return 'Claims';
            if (noteLower.includes('paid as per pv updated')) return 'Claims';
            if (noteLower.includes('tin is oon')) return 'Claims';
            if (noteLower.includes('sequestration applied')) return 'Claims';

            return null;
        }
        
        function initializeTool() {
            const clientSelect = document.getElementById('client-select');
            const configContainer = document.getElementById('configuration-container');
            const uploadContainer = document.getElementById('upload-container');
            const fileInput = document.getElementById('fileInput');
            const yesterdayFileInput = document.getElementById('yesterdayFileInput');
            const processBtn = document.getElementById('processBtn');

            const clientPresets = {
                solis: { label: 'Clean Age (Q):', cleanAgeCol: 'Q', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'U', dsnpCol: 'X', claimTypeCol: 'B', totalChargesCol: 'S', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                liberty: { label: 'Age (R):', cleanAgeCol: 'R', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'V', dsnpCol: 'Y', claimTypeCol: 'B', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                secur: { label: 'Clean Age (Q):', cleanAgeCol: 'Q', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'U', dsnpCol: 'Y', claimTypeCol: 'D', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' },
                csh: { label: 'Age (R):', cleanAgeCol: 'R', claimStatusCol: 'I', payerCol: 'A', networkStatusCol: 'U', dsnpCol: 'Y', claimTypeCol: 'B', totalChargesCol: 'T', dateCols: 'E,O,P', notesCol: 'AA', claimNumberCol: 'C' }
            };

            clientSelect.addEventListener('change', () => {
                const selectedClient = clientSelect.value;
                resetUI();
                if (selectedClient) {
                    const preset = clientPresets[selectedClient];
                    document.getElementById('cleanAgeCol-label').textContent = preset.label;
                    Object.keys(preset).forEach(key => {
                        if (key !== 'label') document.getElementById(key).value = preset[key];
                    });
                    configContainer.classList.remove('hidden');
                    uploadContainer.classList.remove('hidden');
                } else {
                    configContainer.classList.add('hidden');
                    uploadContainer.classList.add('hidden');
                }
            });
            
            const checkFiles = () => {
                document.getElementById('fileName').textContent = fileInput.files[0] ? `Selected: ${fileInput.files[0].name}` : 'No file selected';
                document.getElementById('yesterdayFileName').textContent = yesterdayFileInput.files[0] ? `Selected: ${yesterdayFileInput.files[0].name}` : 'No file selected';
                processBtn.disabled = !fileInput.files[0];
            };

            fileInput.addEventListener('change', checkFiles);
            yesterdayFileInput.addEventListener('change', checkFiles);
            processBtn.addEventListener('click', () => {
                if (fileInput.files[0] && gatherConfig()) {
                    performInitialProcessing(fileInput.files[0], yesterdayFileInput.files[0], gatherConfig());
                }
            });
            document.getElementById('generateFinalReportsBtn').addEventListener('click', generateFinalReports);
            document.getElementById('copyEmailBtn').addEventListener('click', copyEmailText);
        }

        function resetUI() {
            ['review-container', 'final-downloads-container'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('download-links-container').innerHTML = '';
            document.getElementById('copyEmailBtn').classList.add('hidden');
            document.getElementById('status').textContent = '';
        }
        
        function gatherConfig() {
            try {
                const colLetterToIndex = (letter) => {
                    if (!letter || !/^[A-Z]+$/i.test(letter)) return -1;
                    let col = 0; letter = letter.toUpperCase();
                    for (let i = 0; i < letter.length; i++) col += (letter.charCodeAt(i) - 64) * Math.pow(26, letter.length - i - 1);
                    return col - 1;
                };
                const config = {};
                const ids = ['cleanAge', 'claimStatus', 'claimNumber', 'payer', 'networkStatus', 'dsnp', 'claimType', 'totalCharges', 'notes'];
                ids.forEach(id => config[`${id}Index`] = colLetterToIndex(document.getElementById(`${id}Col`).value));
                if (Object.values(config).some(val => val === -1)) throw new Error("Invalid column letter entered.");
                return config;
            } catch (error) {
                displayStatus(`Configuration Error: ${error.message}`, 'error');
                return null;
            }
        }

        function processAndAssignClaims(aoa, config) {
            const claims = [];
            const localPrebatch = [];

            for (const row of aoa.slice(1)) {
                if (row.every(c => c === null)) continue;
                
                const claimState = String(row[config.claimStatusIndex] || '').trim().toUpperCase();
                if (claimState.includes('PREBATCH')) {
                    localPrebatch.push(row);
                    continue;
                }
                
                const noteText = String(row[config.notesIndex] || '');
                const cleanAge = parseInt(row[config.cleanAgeIndex], 10);
                
                let owner = getHardcodedAssignment(noteText);
                if (owner === null) {
                    const totalCharges = parseFloat(String(row[config.totalChargesIndex]).replace(/[^0-9.-]/g, '')) || 0;
                    const claimType = String(row[config.claimTypeIndex] || '').toUpperCase();
                    const isMgmtReview = claimState.includes('MANAGEMENT') && claimState.includes('REVIEW');
                    const isHighCost = isMgmtReview && ((claimType.includes('PROFESSIONAL') && totalCharges > 3500) || (claimType.includes('INSTITUTIONAL') && totalCharges > 6500));
                    
                    if (isHighCost) owner = 'Claims';
                    else if (isMgmtReview || claimState === 'ONHOLD') owner = 'PV';
                    else if (['PEND', 'APPROVED', 'DENY'].includes(claimState)) owner = 'Claims';
                    else if (claimState === 'PR') owner = row[config.payerIndex] || '';
                    else owner = 'PV';
                }
                
                claims.push({ ...config, originalRow: row, noteText, cleanAge, claimState, owner });
            }
            return { claimsList: claims, prebatchList: localPrebatch };
        }
        
        async function performInitialProcessing(mainFile, yesterdayFile, config) {
            displayStatus('Processing... Please wait.', 'info', true);
            resetUI();
            
            [processedClaimsList, prebatchClaims, yesterdayStats] = [[], [], null];
            yesterdayDataMap.clear();
            hasYesterdayFile = !!yesterdayFile;

            const readFileAsAOA = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: null }));
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject(new Error('File reader error'));
                reader.readAsArrayBuffer(file);
            });

            try {
                if (hasYesterdayFile) {
                    const yesterday_aoa = await readFileAsAOA(yesterdayFile);
                    const { claimsList: yestClaims } = processAndAssignClaims(yesterday_aoa, config);
                    yesterdayStats = calculateStats(yestClaims);
                    yestClaims.forEach(claim => {
                        const claimNumber = claim.originalRow[config.claimNumberIndex];
                        if (claimNumber) yesterdayDataMap.set(String(claimNumber).trim(), { state: claim.claimState, owner: claim.owner });
                    });
                }
                
                const main_aoa = await readFileAsAOA(mainFile);
                mainReportHeader = main_aoa[0];
                const { claimsList: todayClaims, prebatchList } = processAndAssignClaims(main_aoa, config);
                processedClaimsList = todayClaims;
                prebatchClaims = prebatchList;

                fileHeaderRow = [...mainReportHeader];
                if (hasYesterdayFile) fileHeaderRow.splice(config.claimStatusIndex, 0, 'Yest. Claim State');
                let daysInsertIndex = config.cleanAgeIndex + 1;
                if (hasYesterdayFile && config.cleanAgeIndex >= config.claimStatusIndex) daysInsertIndex++; 
                fileHeaderRow.splice(daysInsertIndex, 0, 'Days Bucket');
                fileHeaderRow.push('Added (Owner)', 'Due Date');
                
                processedClaimsList.forEach(claim => {
                    const newRow = [...claim.originalRow];
                    if (hasYesterdayFile) {
                        const claimNumber = String(claim.originalRow[config.claimNumberIndex] || '').trim();
                        newRow.splice(config.claimStatusIndex, 0, yesterdayDataMap.get(claimNumber)?.state || 'NEW');
                    }
                    let daysValue = '';
                    if (!isNaN(claim.cleanAge)) {
                        if (claim.cleanAge >= 28 && claim.cleanAge <= 29) daysValue = '28-29 days';
                        else if (claim.cleanAge >= 21 && claim.cleanAge <= 27) daysValue = '21-27 days';
                        else if (claim.cleanAge >= 30) daysValue = '30+ days';
                        else daysValue = '0-20 days';
                    }
                    newRow.splice(daysInsertIndex, 0, daysValue);
                    newRow.push(claim.owner, (claim.noteText.match(/due\s*by?[:\s]*(\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i) || [])[1] || '');
                    claim.processedRow = newRow;
                    claim.defaultOwner = claim.owner;
                    claim.finalOwner = claim.owner;
                });
                
                displayStatus('Processing Complete. Please review and finalize.', 'success');
                displayReviewStep();

            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        function displayReviewStep() {
            const prebatchContainer = document.getElementById('prebatch-container');
            if (prebatchClaims.length > 0) {
                document.getElementById('prebatch-summary').textContent = `Found ${prebatchClaims.length} claims in Prebatch status.`;
                document.getElementById('downloadPrebatchBtn').onclick = downloadPrebatchReport;
                prebatchContainer.classList.remove('hidden');
            } else {
                prebatchContainer.classList.add('hidden');
            }

            const assignmentEditorBody = document.getElementById('assignment-editor-body');
            assignmentEditorBody.innerHTML = '';
            const notesMap = new Map();
            processedClaimsList.forEach(claim => {
                const note = claim.noteText || "No Note";
                if (note !== "No Note" && !getHardcodedAssignment(note)) {
                    if (!notesMap.has(note)) notesMap.set(note, { count: 0, defaultOwner: claim.defaultOwner });
                    notesMap.get(note).count++;
                }
            });

            if (notesMap.size === 0) {
                document.getElementById('assignment-editor-description').textContent = "All notes were assigned automatically. No exceptions to review.";
                assignmentEditorBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No un-coded notes found.</td></tr>`;
            } else {
                document.getElementById('assignment-editor-description').textContent = "The following notes were not automatically assigned. Please review and assign them below.";
                const sortedNotes = Array.from(notesMap.entries()).sort((a, b) => b[1].count - a[1].count);
                sortedNotes.forEach(([note, data]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-700 break-words">${note}</td><td class="px-6 py-4 text-sm text-gray-700">${data.count}</td><td class="px-6 py-4 text-sm font-medium text-gray-900">${data.defaultOwner || 'N/A'}</td><td class="px-6 py-4 text-sm text-gray-500"><select class="p-2 border rounded-md assignment-override" data-note-text="${note}"><option value="">Keep Default</option><option value="Claims">Claims</option><option value="PV">PV</option></select></td>`;
                    assignmentEditorBody.appendChild(row);
                });
            }
            document.getElementById('review-container').classList.remove('hidden');
        }

        function downloadPrebatchReport() {
            const clientName = document.getElementById('client-select').options[document.getElementById('client-select').selectedIndex].text;
            const ws = XLSX.utils.aoa_to_sheet([mainReportHeader, ...prebatchClaims]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Prebatch Claims");
            XLSX.writeFile(wb, `${clientName} Prebatch Report for ${getFormattedDate()}.xlsx`);
        }

        function generateFinalReports() {
            displayStatus('Generating final reports...', 'info', true);
            
            workflowMovement = { pvToClaims: 0, claimsToPv: 0 };
            const noteOverrides = new Map();
            document.querySelectorAll('.assignment-override').forEach(select => {
                if (select.value) noteOverrides.set(select.dataset.noteText, select.value);
            });

            processedClaimsList.forEach(claim => {
                const override = noteOverrides.get(claim.noteText || "No Note");
                if (override) {
                    claim.finalOwner = override;
                    claim.processedRow[claim.processedRow.length - 2] = override;
                }
                if (hasYesterdayFile) {
                    const claimNumber = String(claim.originalRow[claim.claimNumberIndex] || '').trim();
                    const yestData = yesterdayDataMap.get(claimNumber);
                    if (yestData) {
                        const yestOwner = yestData.owner;
                        const todayOwner = claim.finalOwner;
                        if (yestOwner === 'PV' && todayOwner === 'Claims') workflowMovement.pvToClaims++;
                        if (yestOwner === 'Claims' && todayOwner === 'PV') workflowMovement.claimsToPv++;
                    }
                }
            });
            
            const selectedClient = document.getElementById('client-select').value;
            const clientName = document.getElementById('client-select').options[document.getElementById('client-select').selectedIndex].text;
            document.getElementById('download-links-container').innerHTML = '';

            if (selectedClient === 'liberty') {
                createDownloadLink(buildWorkbook(processedClaimsList, `${clientName} Daily Action Report`), `Overall Daily Action Report for ${getFormattedDate()}.xlsx`);
                createDownloadLink(buildWorkbook(processedClaimsList.filter(c => c.finalOwner === 'Claims'), `${clientName} Claims - Action Report`, 'Claims'), `Claims - Action Report for ${getFormattedDate()}.xlsx`);
                createDownloadLink(buildWorkbook(processedClaimsList.filter(c => c.finalOwner === 'PV'), `${clientName} PV - Action Report`, 'PV'), `PV - Action Report for ${getFormattedDate()}.xlsx`);
            } else {
                createDownloadLink(buildWorkbook(processedClaimsList, `${clientName} Daily Action Report`), `${clientName} Daily Action Report for ${getFormattedDate()}.xlsx`);
            }
            
            document.getElementById('final-downloads-container').classList.remove('hidden');
            document.getElementById('copyEmailBtn').classList.remove('hidden');
            displayStatus('Reports generated successfully!', 'success');
        }

        function createDownloadLink(blob, fileName) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.textContent = `Download ${fileName.split(' for')[0]}`;
            link.className = 'inline-block bg-indigo-600 text-white font-bold text-lg rounded-lg py-3 px-6 hover:bg-indigo-700';
            document.getElementById('download-links-container').appendChild(link);
        }

        function buildWorkbook(claimsData, reportTitle, ownerFilter = null) {
            const masterSheetName = "All Processed Data", highDollarSheetName = "High Dollar";
            const sheetsData = { [masterSheetName]: [fileHeaderRow], [highDollarSheetName]: [fileHeaderRow] };
            const tabMetadata = {};

            const overallSummary = {
                par: { '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0, total: 0 },
                nonpar: { '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0, total: 0 }
            };

            for (const claim of claimsData) {
                const networkType = String(claim.originalRow[claim.networkStatusIndex] || '').toUpperCase().includes('OUT') ? 'nonpar' : 'par';
                overallSummary[networkType].total++;
                if (!isNaN(claim.cleanAge)) {
                    if (claim.cleanAge >= 28 && claim.cleanAge <= 29) overallSummary[networkType]['28-29']++;
                    else if (claim.cleanAge >= 21 && claim.cleanAge <= 27) overallSummary[networkType]['21-27']++;
                    else if (claim.cleanAge >= 30) overallSummary[networkType]['30+']++;
                    else overallSummary[networkType]['0-20']++;
                }

                sheetsData[masterSheetName].push(claim.processedRow);
                
                const totalCharges = parseFloat(String(claim.originalRow[claim.totalChargesIndex]).replace(/[^0-9.-]/g, '')) || 0;
                const claimType = String(claim.originalRow[claim.claimTypeIndex] || '').toUpperCase();
                const isMgmtReview = claim.claimState.includes('MANAGEMENT') && claim.claimState.includes('REVIEW');
                const isHighCost = isMgmtReview && ((claimType.includes('PROFESSIONAL') && totalCharges > 3500) || (claimType.includes('INSTITUTIONAL') && totalCharges > 6500));
                
                if (isHighCost) sheetsData[highDollarSheetName].push(claim.processedRow);
                
                 const dsnpRaw = String(claim.originalRow[claim.dsnpIndex] || '').toUpperCase();
                 const dsnpStatus = dsnpRaw.includes('NON DSNP') ? 'NonDSNP' : (dsnpRaw.includes('DSNP') || dsnpRaw === 'Y' ? 'DSNP' : '');
                 let statusTab = '', tabOwner = '';
                 if (isMgmtReview) { statusTab = 'MgmtRev'; tabOwner = 'PV'; }
                 else if (claim.claimState === 'ONHOLD') { statusTab = 'OnHold'; tabOwner = 'PV'; }
                 else if (claim.claimState === 'PEND') { statusTab = 'Pend'; tabOwner = 'Claims'; }
                 else if (claim.claimState === 'DENY') { statusTab = 'Deny'; tabOwner = 'Claims'; }
                 
                 if (dsnpStatus && tabOwner && networkType && !isHighCost) {
                    let tabKey = '', priorityLevel = 0;
                    if (claim.cleanAge >= 28 && claim.cleanAge <= 29) { priorityLevel = 1; tabKey = `CRITICAL (28-29d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                    else if (claim.cleanAge >= 21 && claim.cleanAge <= 27) { priorityLevel = 2; tabKey = `PRIORITY (21-27d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                    else if (claim.cleanAge >= 30) { priorityLevel = 3; tabKey = `Backlog (30+d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                    else { priorityLevel = 4; tabKey = `Queue (0-20d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                    
                    const truncatedTabKey = tabKey.replace(/[\\\/\?\*\[\]]/g, '').substring(0, 31);
                    if (!sheetsData[truncatedTabKey]) { sheetsData[truncatedTabKey] = [fileHeaderRow]; tabMetadata[truncatedTabKey] = { owner: tabOwner, priority: priorityLevel }; }
                    sheetsData[truncatedTabKey].push(claim.processedRow);
                 }

                 const noteLower = claim.noteText.toLowerCase();
                 if (noteLower.includes('w9')) {
                    let w9SheetName = '', w9Owner = '';
                    if (noteLower.includes('req')) { w9SheetName = 'W9 Follow-Up'; w9Owner = 'Claims'; }
                    else if (noteLower.includes('denied') || noteLower.includes('missing')) { w9SheetName = 'W9 Letter Needed'; w9Owner = 'PV'; }
                    else if (noteLower.includes('received') || noteLower.includes('reprocess')) { w9SheetName = 'W9 Received - Reprocess'; w9Owner = 'Claims'; }

                    if (w9SheetName) {
                        if (!sheetsData[w9SheetName]) { sheetsData[w9SheetName] = [fileHeaderRow]; tabMetadata[w9SheetName] = { owner: w9Owner, priority: 5 }; }
                        sheetsData[w9SheetName].push(claim.processedRow);
                    }
                 }
            }

            const coverPageData = [[reportTitle], [`Date: ${getFormattedDate()}`], [], ["Overall Claim Summary"], ["Category", "28-29 Days (Critical)", "21-27 Days (Priority)", "30+ Days (Backlog)", "0-20 Days (Queue)", "Total Active Claims"], ["Par Claims", overallSummary.par['28-29'], overallSummary.par['21-27'], overallSummary.par['30+'], overallSummary.par['0-20'], overallSummary.par.total], ["Non-Par Claims", overallSummary.nonpar['28-29'], overallSummary.nonpar['21-27'], overallSummary.nonpar['30+'], overallSummary.nonpar['0-20'], overallSummary.nonpar.total], [], ["Core Strategy: Focus on claims nearing the 30-day threshold. Work tabs in priority order."], []];
            
            const allBreakoutTabs = Object.keys(tabMetadata);
            const addSectionToCover = (title, priority) => {
                const filteredTabs = allBreakoutTabs.filter(key => tabMetadata[key] && tabMetadata[key].priority === priority && (!ownerFilter || tabMetadata[key].owner === ownerFilter)).sort();
                if (filteredTabs.length > 0) {
                    coverPageData.push([title], ["Tab Name", "Claim Count", "Assigned Owner"]);
                    filteredTabs.forEach(key => coverPageData.push([key, sheetsData[key].length - 1, tabMetadata[key].owner]));
                    coverPageData.push([]);
                }
            };
            addSectionToCover("Priority 1: CRITICAL (28-29 days)", 1);
            addSectionToCover("Priority 2: PRIORITY (21-27 days)", 2);
            addSectionToCover("Priority 3: Backlog (30+ days)", 3);
            addSectionToCover("Priority 4: Standard Queue (0-20 days)", 4);
            addSectionToCover("W9 and Other Tasks", 5);

            const wb = XLSX.utils.book_new();
            const coverWS = XLSX.utils.aoa_to_sheet(coverPageData);
            coverWS['!cols'] = [{ wch: 35 }, { wch: 20 }, { wch: 22 }];
            XLSX.utils.book_append_sheet(wb, coverWS, "Cover Page");
            
            const sheetOrder = ["Cover Page", highDollarSheetName, ...allBreakoutTabs.sort((a,b) => (tabMetadata[a].priority - tabMetadata[b].priority) || a.localeCompare(b)), masterSheetName];
            sheetOrder.forEach(sheetName => {
                if (sheetsData[sheetName] && sheetsData[sheetName].length > 1 && (!ownerFilter || (tabMetadata[sheetName] && tabMetadata[sheetName].owner === ownerFilter) || [masterSheetName, highDollarSheetName].includes(sheetName))) {
                    const ws = XLSX.utils.aoa_to_sheet(sheetsData[sheetName]);
                    ws['!autofilter'] = { ref: ws['!ref'] };
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });

            return new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }

        function calculateStats(claimsList) {
            const dayBuckets = { '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0 };
            const stats = { 'PEND': { total: 0, ...dayBuckets }, 'ONHOLD': { total: 0, ...dayBuckets }, 'MANAGEMENTREVIEW': { total: 0, ...dayBuckets }, 'DENY': { total: 0, ...dayBuckets } };
            
            for(const claim of claimsList) {
                let finalClaimState = claim.claimState;
                if (claim.claimState.includes('MANAGEMENT') && claim.claimState.includes('REVIEW')) {
                    finalClaimState = 'MANAGEMENTREVIEW'; // Normalize for stats
                }
                
                if (stats[finalClaimState]) {
                    stats[finalClaimState].total++;
                    let daysValue = '';
                    if (!isNaN(claim.cleanAge)) {
                        if (claim.cleanAge >= 28 && claim.cleanAge <= 29) daysValue = '28-29';
                        else if (claim.cleanAge >= 21 && claim.cleanAge <= 27) daysValue = '21-27';
                        else if (claim.cleanAge >= 30) daysValue = '30+';
                        else daysValue = '0-20';
                        if (stats[finalClaimState][daysValue] !== undefined) stats[finalClaimState][daysValue]++;
                    }
                }
            }
            return stats;
        }

        function copyEmailText() {
            const todayStats = calculateStats(processedClaimsList);
            const clientName = document.getElementById('client-select').options[document.getElementById('client-select').selectedIndex].text;
            const intro = hasYesterdayFile 
                ? `Attached is today's Daily Action Report for ${clientName}. Previous day's counts are in (parenthesis).`
                : `Attached is today's Daily Action Report for ${clientName}.`;
            
            const formatStatLine = (t, y) => hasYesterdayFile ? `${t} (${y ?? 0})` : `${t}`;
            
            const createStatBlock = (title, todayBlock, yestBlock) => {
                const y = yestBlock || { total: 0, '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0 };
                return `Number of total claims ${title}: ${formatStatLine(todayBlock.total, y.total)}\n` +
                       `CRITICAL (28-29 Days): ${formatStatLine(todayBlock['28-29'], y['28-29'])}\n` +
                       `PRIORITY (21-27 Days): ${formatStatLine(todayBlock['21-27'], y['21-27'])}\n` +
                       `Backlog (30+ Days): ${formatStatLine(todayBlock['30+'], y['30+'])}\n` +
                       `Queue (0-20 Days): ${formatStatLine(todayBlock['0-20'], y['0-20'])}`;
            };

            let movementSummary = '';
            if (hasYesterdayFile) {
                movementSummary = `\n\n**Workflow Movement Summary:**\n- Claims moved from PV to Claims: ${workflowMovement.pvToClaims}\n- Claims moved from Claims to PV: ${workflowMovement.claimsToPv}`;
            }

            const emailBody = `Hello Teams,\n\n${intro}\n\nBelow are the detailed highlights from the report:\n\n` +
                  `${createStatBlock('pending', todayStats['PEND'], yesterdayStats?.['PEND'])}\n\n` +
                  `${createStatBlock('On Hold', todayStats['ONHOLD'], yesterdayStats?.['ONHOLD'])}\n\n` +
                  `${createStatBlock('in Management Review', todayStats['MANAGEMENTREVIEW'], yesterdayStats?.['MANAGEMENTREVIEW'])}\n\n` +
                  `${createStatBlock('in Denied status', todayStats['DENY'], yesterdayStats?.['DENY'])}${movementSummary}\n\nPlease let me know if you have any questions.`;
            
            navigator.clipboard.writeText(emailBody).then(() => {
                const btn = document.getElementById('copyEmailBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 2000);
            }).catch(err => alert('Failed to copy text.'));
        }
        
        function getFormattedDate() {
            const d = new Date(), day = d.getDate(), month = d.toLocaleString('default', { month: 'short' }), year = d.getFullYear();
            const s = (day % 10 == 1 && day != 11) ? 'st' : ((day % 10 == 2 && day != 12) ? 'nd' : ((day % 10 == 3 && day != 13) ? 'rd' : 'th'));
            return `${day}${s} ${month} ${year}`;
        }

        function displayStatus(message, type, showLoader = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : '#4f46e5');
            document.getElementById('loader').style.display = showLoader ? 'block' : 'none';
            document.getElementById('processBtn').disabled = !!showLoader;
        }

        document.addEventListener('DOMContentLoaded', initializeTool);
    </script>
</body>
</html>
