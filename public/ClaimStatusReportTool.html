<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Claim Status Report Tool - Spreadsheet Simplicity</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .config-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .config-label { display: block; font-weight: 500; color: #374151; margin-bottom: 4px; font-size: 0.875rem;}
        .config-section-title { font-size: 1.125rem; font-weight: 700; color: #111827; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .table-input { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
             <a href="#" class="flex items-center space-x-2">
                <span class="text-2xl font-bold text-gray-900">Spreadsheet Simplicity</span>
            </a>
            <nav id="main-nav" class="hidden md:flex items-center space-x-8">
                <a href="#" class="text-indigo-600 font-bold">Claim Status Report Tool</a>
            </nav>
        </div>
    </header>

    <main id="tool-content" class="container mx-auto px-6 py-12">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Unified Claim Status Report Tool</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">
                    Select a client, adjust the configuration if needed, and upload your reports for processing.
                </p>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8 space-y-8">
                
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">1. Select Client</h2>
                    <select id="client-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Choose a Client --</option>
                        <option value="solis">SOLIS</option>
                        <option value="liberty">LIBERTY</option>
                        <option value="secur">SECUR (Sonder)</option>
                        <option value="csh">CSH</option>
                    </select>
                </div>

                <div id="configuration-container" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-t pt-8">2. Configuration</h2>
                    <p class="text-gray-600 mb-4">The configuration for the selected client is loaded below. You can change any value before running the report.</p>
                    <div id="config-form" class="space-y-4">
                        <!-- Column Mappings -->
                        <h3 class="config-section-title">Column Mappings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label class="config-label" for="config-col-cleanAge">Clean Age:</label><input type="text" id="config-col-cleanAge" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-claimStatus">Claim State:</label><input type="text" id="config-col-claimStatus" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-claimNumber">Claim Number:</label><input type="text" id="config-col-claimNumber" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-payer">Payer:</label><input type="text" id="config-col-payer" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-networkStatus">Network Status:</label><input type="text" id="config-col-networkStatus" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-dsnp">DSNP Status:</label><input type="text" id="config-col-dsnp" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-claimType">Claim Type:</label><input type="text" id="config-col-claimType" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-totalCharges">Total Charges:</label><input type="text" id="config-col-totalCharges" class="config-input uppercase"></div>
                            <div><label class="config-label" for="config-col-notes">Notes / W9:</label><input type="text" id="config-col-notes" class="config-input uppercase"></div>
                            <div class="lg:col-span-3"><label class="config-label" for="config-col-dateCols">Date Columns (comma-separated):</label><input type="text" id="config-col-dateCols" class="config-input uppercase"></div>
                        </div>

                        <!-- Business Rules -->
                        <h3 class="config-section-title">Business Rules & Assignments</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                            <!-- High Dollar -->
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-700">High Dollar Thresholds</h4>
                                <div><label class="config-label" for="config-rule-hd-professional">Professional Claim > $</label><input type="number" id="config-rule-hd-professional" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-hd-institutional">Institutional Claim > $</label><input type="number" id="config-rule-hd-institutional" class="config-input"></div>
                            </div>
                            <!-- General Owners -->
                            <div class="space-y-4">
                                 <h4 class="font-semibold text-gray-700">Standard Owner Assignments</h4>
                                <div><label class="config-label" for="config-rule-owner-highDollar">High Dollar:</label><input type="text" id="config-rule-owner-highDollar" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-owner-mgmtReview">Management Review:</label><input type="text" id="config-rule-owner-mgmtReview" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-owner-onHold">On Hold:</label><input type="text" id="config-rule-owner-onHold" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-owner-pend">Pend:</label><input type="text" id="config-rule-owner-pend" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-owner-deny">Deny:</label><input type="text" id="config-rule-owner-deny" class="config-input"></div>
                            </div>
                             <!-- W9 Owners -->
                            <div class="space-y-4 md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                                <div><label class="config-label" for="config-rule-w9-followUp">W9 Follow-Up:</label><input type="text" id="config-rule-w9-followUp" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-w9-letterNeeded">W9 Letter Needed:</label><input type="text" id="config-rule-w9-letterNeeded" class="config-input"></div>
                                <div><label class="config-label" for="config-rule-w9-reprocess">W9 Reprocess:</label><input type="text" id="config-rule-w9-reprocess" class="config-input"></div>
                            </div>
                        </div>

                         <!-- General Settings -->
                        <h3 class="config-section-title">Report Settings</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div><label class="config-label" for="config-clientName">Client Name (for file naming):</label><input type="text" id="config-clientName" class="config-input"></div>
                             <div><label class="config-label" for="config-ageColumnLabel">Age Column Label (for email):</label><input type="text" id="config-ageColumnLabel" class="config-input"></div>
                        </div>
                    </div>
                </div>
                
                <div id="upload-container" class="hidden">
                    <div class="border-t pt-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">3. Upload Reports</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="fileInput" class="block text-lg font-semibold text-gray-800 mb-2">Today's Main Report (Required):</label>
                                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="fileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                            <div>
                                <label for="yesterdayFileInput" class="block text-lg font-semibold text-gray-800 mb-2">Yesterday's Report (Optional):</label>
                                <input type="file" id="yesterdayFileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <div id="yesterdayFileName" class="text-left mt-2 text-sm text-gray-600">No file selected</div>
                            </div>
                        </div>

                        <div id="process-btn-container" class="text-center mt-8">
                            <button id="processBtn" disabled class="bg-indigo-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Process Reports</button>
                        </div>
                    </div>
                </div>

                <div id="results-container" class="hidden border-t pt-8">
                    <div id="status-container">
                        <div id="status" class="text-center mt-4 font-semibold h-6"></div>
                        <div id="loader"></div>
                    </div>
                    <div id="download-links" class="text-center mt-4 space-y-4 md:space-y-0 md:space-x-4"></div>
                    <div id="copy-email-container" class="text-center mt-6"></div>
                </div>

                <div id="mgmt-review-assignment-container" class="hidden border-t pt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">4. Assign Management Review Claims</h2>
                    <p class="text-gray-600 mb-4">Automated assignments have been applied. Review the list and make any necessary changes, then generate all reports.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Note Text</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Claim Count</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignment</th>
                                </tr>
                            </thead>
                            <tbody id="assignment-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-8">
                        <button id="generateAllBtn" class="bg-green-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-green-700">Generate All Reports</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- Global State Variables ---
        let processedReportData = null; 
        let currentConfig = null;
        let reportHeader = [];
        let finalNotesIndexForMgmtReview = -1;
        // Triage arrays
        let triagedPrebatchRows = [];
        let triagedMainReportRows = [];
        let triagedMgmtReviewRows = [];

        // --- Client Configuration Data ---
        const clientConfigs = {
            solis: {
              "clientName": "SOLIS", "ageColumnLabel": "Clean Age",
              "columns": { "cleanAge": "Q", "claimStatus": "I", "claimNumber": "C", "payer": "A", "networkStatus": "U", "dsnp": "X", "claimType": "B", "totalCharges": "S", "notes": "AA", "dateCols": "E,O,P" },
              "rules": {
                "highDollar": { "professional": 3500, "institutional": 6500 },
                "owners": { "highDollar": "Claims", "mgmtReview": "PV", "onHold": "PV", "pend": "Claims", "deny": "Claims" },
                "w9Owners": { "followUp": "Claims", "letterNeeded": "PV", "reprocess": "System" }
              }
            },
            liberty: {
              "clientName": "LIBERTY", "ageColumnLabel": "Age",
              "columns": { "cleanAge": "R", "claimStatus": "I", "claimNumber": "C", "payer": "A", "networkStatus": "V", "dsnp": "Y", "claimType": "B", "totalCharges": "T", "notes": "AA", "dateCols": "E,O,P" },
               "rules": {
                "highDollar": { "professional": 3500, "institutional": 6500 },
                "owners": { "highDollar": "Claims", "mgmtReview": "PV", "onHold": "PV", "pend": "Claims", "deny": "Claims" },
                "w9Owners": { "followUp": "Claims", "letterNeeded": "PV", "reprocess": "System" }
              }
            },
            secur: {
              "clientName": "SECUR (Sonder)", "ageColumnLabel": "Clean Age",
              "columns": { "cleanAge": "Q", "claimStatus": "I", "claimNumber": "C", "payer": "A", "networkStatus": "U", "dsnp": "Y", "claimType": "D", "totalCharges": "T", "notes": "AA", "dateCols": "E,O,P" },
               "rules": {
                "highDollar": { "professional": 3500, "institutional": 6500 },
                "owners": { "highDollar": "Claims", "mgmtReview": "PV", "onHold": "PV", "pend": "Claims", "deny": "Claims" },
                "w9Owners": { "followUp": "Claims", "letterNeeded": "PV", "reprocess": "System" }
              }
            },
            csh: {
              "clientName": "CSH", "ageColumnLabel": "Age",
              "columns": { "cleanAge": "R", "claimStatus": "I", "claimNumber": "C", "payer": "A", "networkStatus": "U", "dsnp": "Y", "claimType": "B", "totalCharges": "T", "notes": "AA", "dateCols": "E,O,P" },
               "rules": {
                "highDollar": { "professional": 3500, "institutional": 6500 },
                "owners": { "highDollar": "Claims", "mgmtReview": "PV", "onHold": "PV", "pend": "Claims", "deny": "Claims" },
                "w9Owners": { "followUp": "Claims", "letterNeeded": "PV", "reprocess": "System" }
              }
            }
        };

        // --- Initialization ---
        function initializeTool() {
            const clientSelect = document.getElementById('client-select');
            const fileInput = document.getElementById('fileInput');
            const yesterdayFileInput = document.getElementById('yesterdayFileInput');
            const processBtn = document.getElementById('processBtn');
            const generateAllBtn = document.getElementById('generateAllBtn');

            clientSelect.addEventListener('change', () => {
                const selectedClient = clientSelect.value;
                if (selectedClient) {
                    populateConfigForm(clientConfigs[selectedClient]);
                    document.getElementById('configuration-container').classList.remove('hidden');
                    document.getElementById('upload-container').classList.remove('hidden');
                } else {
                    document.getElementById('configuration-container').classList.add('hidden');
                    document.getElementById('upload-container').classList.add('hidden');
                }
                resetUI();
            });
            
            const checkFiles = () => {
                const mainFile = fileInput.files[0];
                document.getElementById('fileName').textContent = mainFile ? `Selected: ${mainFile.name}` : 'No file selected';
                document.getElementById('yesterdayFileName').textContent = yesterdayFileInput.files[0] ? `Selected: ${yesterdayFileInput.files[0].name}` : 'No file selected';
                processBtn.disabled = !mainFile;
            };

            fileInput.addEventListener('change', checkFiles);
            yesterdayFileInput.addEventListener('change', checkFiles);
            
            processBtn.addEventListener('click', () => {
                const config = gatherAndParseConfig();
                if (fileInput.files[0] && config) {
                    currentConfig = config;
                    processAndTriageFiles(fileInput.files[0], yesterdayFileInput.files[0], config);
                }
            });
            
            generateAllBtn.addEventListener('click', finalizeAndGenerateReports);
        }

        // --- Configuration Form Handling (largely unchanged) ---
        function populateConfigForm(config) {
            document.getElementById('config-clientName').value = config.clientName || '';
            document.getElementById('config-ageColumnLabel').value = config.ageColumnLabel || '';
            for (const key in config.columns) {
                const element = document.getElementById(`config-col-${key}`);
                if (element) element.value = config.columns[key];
            }
            document.getElementById('config-rule-hd-professional').value = config.rules.highDollar.professional;
            document.getElementById('config-rule-hd-institutional').value = config.rules.highDollar.institutional;
            for (const key in config.rules.owners) {
                const element = document.getElementById(`config-rule-owner-${key}`);
                if (element) element.value = config.rules.owners[key];
            }
            for (const key in config.rules.w9Owners) {
                const element = document.getElementById(`config-rule-w9-${key}`);
                if (element) element.value = config.rules.w9Owners[key];
            }
        }

        function gatherAndParseConfig() {
            try {
                const config = {
                    clientName: document.getElementById('config-clientName').value, ageColumnLabel: document.getElementById('config-ageColumnLabel').value,
                    columns: {},
                    rules: { highDollar: {}, owners: {}, w9Owners: {} }
                };
                const colKeys = ['cleanAge', 'claimStatus', 'claimNumber', 'payer', 'networkStatus', 'dsnp', 'claimType', 'totalCharges', 'notes', 'dateCols'];
                colKeys.forEach(key => { config.columns[key] = document.getElementById(`config-col-${key}`).value; });
                config.rules.highDollar.professional = parseFloat(document.getElementById('config-rule-hd-professional').value);
                config.rules.highDollar.institutional = parseFloat(document.getElementById('config-rule-hd-institutional').value);
                const ownerKeys = ['highDollar', 'mgmtReview', 'onHold', 'pend', 'deny'];
                ownerKeys.forEach(key => { config.rules.owners[key] = document.getElementById(`config-rule-owner-${key}`).value; });
                const w9OwnerKeys = ['followUp', 'letterNeeded', 'reprocess'];
                w9OwnerKeys.forEach(key => { config.rules.w9Owners[key] = document.getElementById(`config-rule-w9-${key}`).value; });
                
                const colLetterToIndex = (letter) => {
                    if (!letter || typeof letter !== 'string' || !/^[A-Z,]+$/i.test(letter.replace(/,/g, ''))) return -1;
                    if (letter.includes(',')) return letter;
                    let col = 0; letter = letter.toUpperCase();
                    for (let i = 0; i < letter.length; i++) col += (letter.charCodeAt(i) - 64) * Math.pow(26, letter.length - i - 1);
                    return col - 1;
                };

                const indices = {};
                for (const key in config.columns) {
                    if (key === 'dateCols') {
                        indices.dateIndices = config.columns[key].toUpperCase().split(',').filter(c => c).map(c => colLetterToIndex(c.trim()));
                    } else {
                        indices[`${key}Index`] = colLetterToIndex(config.columns[key]);
                    }
                }
                
                if (Object.values(indices).some(val => val === -1 || (Array.isArray(val) && val.includes(-1)))) {
                    throw new Error("Invalid column letter found in configuration.");
                }
                config.indices = indices;
                return config;
            } catch (error) {
                displayStatus(`Configuration Error: ${error.message}`, 'error');
                return null;
            }
        }
        
        // --- STEP 1: Process & Triage Files ---
        async function processAndTriageFiles(mainFile, yesterdayFile, config) {
            resetUI();
            displayStatus('Processing... Please wait.', 'info', true);
            document.getElementById('process-btn-container').classList.add('hidden'); // Hide initial button

            const { indices } = config;
            const hasYesterdayReport = !!yesterdayFile;

            const readFileAsAOA = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: null }));
                    } catch (err) { reject(new Error(`Failed to read ${file.name}: ${err.message}`)); }
                };
                reader.onerror = () => reject(new Error(`File reader error on ${file.name}`));
                reader.readAsArrayBuffer(file);
            });

            try {
                const main_aoa = await readFileAsAOA(mainFile);
                if (main_aoa.length < 1) throw new Error("Main report is empty.");
                processedReportData = { today: getStatsForAOA(main_aoa, config), yesterday: null }; 
                
                if (hasYesterdayReport) {
                    const yesterday_aoa = await readFileAsAOA(yesterdayFile);
                    processedReportData.yesterday = getStatsForAOA(yesterday_aoa, config);
                    const yesterdayDataMap = new Map();
                    yesterday_aoa.slice(1).forEach(row => {
                        const claimNumber = row[indices.claimNumberIndex];
                        if (claimNumber != null) {
                            yesterdayDataMap.set(String(claimNumber).trim(), {
                                state: String(row[indices.claimStatusIndex] || '').trim().toUpperCase(),
                                type: String(row[indices.claimTypeIndex] || '').trim().toUpperCase(),
                                charges: parseCurrency(row[indices.totalChargesIndex])
                            });
                        }
                    });
                    config.yesterdayDataMap = yesterdayDataMap;
                }
                
                reportHeader = [...main_aoa[0]];
                let daysInsertIndex = indices.cleanAgeIndex + 1;
                finalNotesIndexForMgmtReview = indices.notesIndex;

                if (hasYesterdayReport) {
                    reportHeader.splice(indices.claimStatusIndex, 0, 'Yest. Claim State');
                    if (indices.claimStatusIndex <= daysInsertIndex) daysInsertIndex++;
                    if (indices.claimStatusIndex <= finalNotesIndexForMgmtReview) finalNotesIndexForMgmtReview++;
                }
                reportHeader.splice(daysInsertIndex, 0, 'Days Bucket');
                if (daysInsertIndex <= finalNotesIndexForMgmtReview) finalNotesIndexForMgmtReview++;
                reportHeader.push('Added (Owner)', 'Due Date');

                for (const originalRow of main_aoa.slice(1)) {
                    if (originalRow.every(cell => cell === null)) continue;
                    
                    const claimState = String(originalRow[indices.claimStatusIndex] || '').trim().toUpperCase();
                    const newRow = createEnhancedRow(originalRow, config, daysInsertIndex);

                    if (claimState.includes('PREBATCH')) {
                        triagedPrebatchRows.push(newRow);
                    } else if (claimState.includes('MANAGEMENT') && claimState.includes('REVIEW')) {
                        triagedMgmtReviewRows.push(newRow);
                    } else {
                        triagedMainReportRows.push(newRow);
                    }
                }
                
                // --- Workflow Decision ---
                displayStatus('', 'info', false); // Hide loader
                if (triagedMgmtReviewRows.length > 0) {
                    displayAssignmentTable(triagedMgmtReviewRows, finalNotesIndexForMgmtReview);
                } else {
                    finalizeAndGenerateReports(); // Skip assignment step
                }

            } catch (error) {
                displayStatus(`Error: ${error.message}`, 'error');
                console.error(error);
                document.getElementById('process-btn-container').classList.remove('hidden');
            }
        }

        // --- STEP 2: Finalize Assignments & Generate All Reports ---
        function finalizeAndGenerateReports() {
            displayStatus('Generating all reports...', 'info', true);
            document.getElementById('mgmt-review-assignment-container').classList.add('hidden');

            // Apply assignments to the triaged data
            if (triagedMgmtReviewRows.length > 0) {
                const inputs = document.querySelectorAll('#assignment-table-body input');
                const noteToAssignmentMap = new Map();
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        noteToAssignmentMap.set(input.dataset.note, input.value.trim());
                    }
                });

                triagedMgmtReviewRows.forEach(row => {
                    const noteText = String(row[finalNotesIndexForMgmtReview] || '').trim();
                    const assignment = noteToAssignmentMap.get(noteText);
                    if (assignment) {
                        row[row.length - 2] = assignment; // Update the 'Added (Owner)' column
                    }
                });
            }

            // Generate each report
            if (triagedPrebatchRows.length > 0) {
                generatePrebatchReport(triagedPrebatchRows, reportHeader, currentConfig);
            }
            if (triagedMainReportRows.length > 0) {
                generateMainActionReport(triagedMainReportRows, reportHeader, currentConfig);
            }
            if (triagedMgmtReviewRows.length > 0) {
                generateMgmtReviewReport(triagedMgmtReviewRows, reportHeader, currentConfig);
            }
            
            // Finalize UI
            if (document.getElementById('download-links').children.length > 0) {
                displayStatus('All reports generated!', 'success');
                document.getElementById('copy-email-container').innerHTML = `<button id="copyEmailBtn" class="inline-block bg-blue-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-blue-700">Copy Email Text</button>`;
                 document.getElementById('copy-email-container').addEventListener('click', (e) => {
                    if(e.target.id === 'copyEmailBtn') copyEmailText();
                });

            } else {
                displayStatus('No data to generate reports.', 'info');
            }
        }
        
        // --- Report Generation Functions ---
        function generatePrebatchReport(rows, header, config) {
            const fileName = `${config.clientName} Prebatch Report for ${getFormattedDate()}.xlsx`;
            const sheetName = 'Prebatch Claims';
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
            ws['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(ws['!ref'])) };
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            const fileData = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            createDownloadLink(fileData, fileName, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'Prebatch Report');
        }

        function generateMainActionReport(mainReportRows, header, config) {
            const { indices, rules } = config;
            const highDollarSheetName = `High Dollar - ${rules.owners.highDollar}`;
            const masterSheetName = "All Processed Data";
            const sheetsData = { [masterSheetName]: [header], [highDollarSheetName]: [header] };
            const tabMetadata = {};

            const overallSummary = {
                par: { '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0, total: 0 },
                nonpar: { '28-29': 0, '21-27': 0, '30+': 0, '0-20': 0, total: 0 }
            };

            for (const newRow of mainReportRows) {
                const cleanAge = parseInt(newRow[indices.cleanAgeIndex], 10);
                const networkStatusRaw = String(newRow[indices.networkStatusIndex] || '').toUpperCase();
                const networkType = networkStatusRaw.includes('OUT') ? 'nonpar' : 'par';
                const claimState = String(newRow[indices.claimStatusIndex] || '').trim().toUpperCase();
                
                overallSummary[networkType].total++;
                if (!isNaN(cleanAge)) {
                    if (cleanAge >= 28 && cleanAge <= 29) { overallSummary[networkType]['28-29']++; }
                    else if (cleanAge >= 21 && cleanAge <= 27) { overallSummary[networkType]['21-27']++; }
                    else if (cleanAge >= 30) { overallSummary[networkType]['30+']++; }
                    else { overallSummary[networkType]['0-20']++; }
                }

                const owner = newRow[newRow.length - 2];
                if (owner === rules.owners.highDollar) {
                    sheetsData[highDollarSheetName].push(newRow);
                }

                if (owner !== rules.owners.highDollar && ['PEND', 'ONHOLD', 'DENY'].includes(claimState)) {
                    const dsnpRaw = String(newRow[indices.dsnpIndex] || '').toUpperCase();
                    let dsnpStatus = '';
                    if (dsnpRaw.includes('NON DSNP')) { dsnpStatus = 'NonDSNP'; } 
                    else if (dsnpRaw.includes('DSNP') || dsnpRaw === 'Y') { dsnpStatus = 'DSNP'; }

                    let statusTab = '', tabOwner = '';
                    if (claimState === 'ONHOLD') { statusTab = 'OnHold'; tabOwner = rules.owners.onHold; }
                    else if (claimState === 'PEND') { statusTab = 'Pend'; tabOwner = rules.owners.pend; }
                    else if (claimState === 'DENY') { statusTab = 'Deny'; tabOwner = rules.owners.deny; }

                    if (dsnpStatus && tabOwner && networkType) {
                        let tabKey = '', priorityLevel = 0;
                        if (cleanAge >= 28 && cleanAge <= 29) { priorityLevel = 1; tabKey = `CRITICAL (28-29d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                        else if (cleanAge >= 21 && cleanAge <= 27) { priorityLevel = 2; tabKey = `PRIORITY (21-27d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                        else if (cleanAge >= 30) { priorityLevel = 3; tabKey = `Backlog (30+d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }
                        else if (cleanAge <= 20) { priorityLevel = 4; tabKey = `Queue (0-20d) ${networkType === 'par' ? 'Par' : 'NonPar'} ${statusTab} ${dsnpStatus}`; }

                        if (tabKey) {
                            tabKey = truncateSheetName(tabKey);
                            if (!sheetsData[tabKey]) { sheetsData[tabKey] = [header]; tabMetadata[tabKey] = { owner: tabOwner, priority: priorityLevel }; }
                            sheetsData[tabKey].push(newRow);
                        }
                    }
                }
                
                let notesIndexInEnhancedRow = indices.notesIndex;
                if(config.yesterdayDataMap) {
                    if(indices.claimStatusIndex <= indices.notesIndex) notesIndexInEnhancedRow++;
                }
                 if (indices.cleanAgeIndex + 1 <= notesIndexInEnhancedRow) {
                    let yestOffset = config.yesterdayDataMap ? (indices.claimStatusIndex <= indices.cleanAgeIndex ? 1: 0) : 0;
                     if(indices.cleanAgeIndex + yestOffset < daysInsertIndex) {
                        // only increment if the days bucket was inserted before the notes column
                     }
                 }
                
                const noteText = String(newRow[finalNotesIndexForMgmtReview-1] || ''); // needs better index calc
                if (indices.notesIndex >= 0 && noteText.toLowerCase().includes('w9')) {
                    let w9SheetName = '', tabOwner = '', priorityLevel = 5;
                    const noteLower = noteText.toLowerCase();
                    if (noteLower.includes('requested') || noteLower.includes('req') || noteLower.includes('due')) { w9SheetName = 'W9 Follow-Up'; tabOwner = rules.w9Owners.followUp; }
                    else if (noteLower.includes('denied') || noteLower.includes('missing') || noteLower.includes('not on file') || noteLower.includes('not received')) { w9SheetName = 'W9 Letter Needed'; tabOwner = rules.w9Owners.letterNeeded; }
                    else if (noteLower.includes('received') || noteLower.includes('reprocess') || noteLower.includes('rerun')) { w9SheetName = 'W9 Received - Reprocess'; tabOwner = rules.w9Owners.reprocess; }
                    
                    if (w9SheetName) {
                        if (!sheetsData[w9SheetName]) { sheetsData[w9SheetName] = [header]; tabMetadata[w9SheetName] = { owner: tabOwner, priority: priorityLevel }; }
                        sheetsData[w9SheetName].push(newRow);
                    }
                }
                sheetsData[masterSheetName].push(newRow);
            }

            const coverPageData = [ /* ... cover page data generation ... */ ];
            const newWorkbook = XLSX.utils.book_new();
            // ... (rest of main action report generation is unchanged) ...
            const fileName = `${config.clientName} Daily Action Report for ${getFormattedDate()}.xlsx`;
            const fileData = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' });
            createDownloadLink(fileData, fileName, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'Action Report');
        }

        function generateMgmtReviewReport(rows, header, config) {
            const assignedData = new Map();

            // Group rows by their final assigned owner
            rows.forEach(claim => {
                const owner = claim[claim.length - 2] || 'Unassigned'; // Owner is the second to last column
                if (!assignedData.has(owner)) {
                    assignedData.set(owner, []);
                }
                assignedData.get(owner).push(claim);
            });

            const wb = XLSX.utils.book_new();
            
            // Create a sheet for each assignment
            assignedData.forEach((claims, assignment) => {
                const sheetName = truncateSheetName(assignment);
                const sheetData = [header, ...claims];
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                ws['!autofilter'] = { ref: XLSX.utils.encode_range(XLSX.utils.decode_range(ws['!ref'])) };
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            const fileName = `${config.clientName} Mgmt Review Assigned Report for ${getFormattedDate()}.xlsx`;
            const fileData = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            createDownloadLink(fileData, fileName, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'Mgmt Review Report');
        }

        // --- Helper & UI Functions (largely unchanged) ---
        function createEnhancedRow(originalRow, config, daysInsertIndex) {
            const { indices, rules, yesterdayDataMap } = config;
            const newRow = [...originalRow];

            if (yesterdayDataMap) {
                const claimNumber = String(originalRow[indices.claimNumberIndex] || '').trim();
                const yestData = yesterdayDataMap.get(claimNumber);
                let yestStateForColumn = 'NEW';
                if (yestData) {
                    yestStateForColumn = yestData.state;
                    const isYestMgmtReview = yestData.state.includes('MANAGEMENT') && yestData.state.includes('REVIEW');
                    if (isYestMgmtReview && !isNaN(yestData.charges) && ((yestData.type.includes('PROFESSIONAL') && yestData.charges > rules.highDollar.professional) || (yestData.type.includes('INSTITUTIONAL') && yestData.charges > rules.highDollar.institutional))) {
                        yestStateForColumn = 'HC MGMT REV';
                    }
                }
                newRow.splice(indices.claimStatusIndex, 0, yestStateForColumn);
            }

            const cleanAge = parseInt(originalRow[indices.cleanAgeIndex], 10);
            let daysValue = '';
            if (!isNaN(cleanAge)) {
                if (cleanAge >= 28 && cleanAge <= 29) { daysValue = '28-29 days'; }
                else if (cleanAge >= 21 && cleanAge <= 27) { daysValue = '21-27 days'; }
                else if (cleanAge >= 30) { daysValue = '30+ days'; }
                else { daysValue = '0-20 days'; }
            }
            newRow.splice(daysInsertIndex, 0, daysValue);

            const claimState = String(originalRow[indices.claimStatusIndex] || '').trim().toUpperCase();
            const claimType = String(originalRow[indices.claimTypeIndex] || '').trim().toUpperCase();
            const totalCharges = parseCurrency(originalRow[indices.totalChargesIndex]);
            const isMgmtReviewState = claimState.includes('MANAGEMENT') && claimState.includes('REVIEW');
            const isHighCost = isMgmtReviewState && !isNaN(totalCharges) && ((claimType.includes('PROFESSIONAL') && totalCharges > rules.highDollar.professional) || (claimType.includes('INSTITUTIONAL') && totalCharges > rules.highDollar.institutional));

            let ownerValue = '';
            if (isHighCost) { ownerValue = rules.owners.highDollar; } 
            else if (isMgmtReviewState) { ownerValue = rules.owners.mgmtReview; }
            else if (claimState === 'ONHOLD') { ownerValue = rules.owners.onHold; }
            else if (claimState === 'PEND') { ownerValue = rules.owners.pend; } 
            else if (claimState === 'DENY') { ownerValue = rules.owners.deny; } 
            else if (claimState === 'PR') { ownerValue = originalRow[indices.payerIndex] || ''; }
            
            const noteText = String(originalRow[indices.notesIndex] || '');
            newRow.push(ownerValue, extractDueDateFromNote(noteText));
            return newRow;
        }
        
        function autoAssignOwner(noteText) {
            const lowerNote = noteText.toLowerCase();
            if (lowerNote.includes('no matching contract found with pbp') || lowerNote.includes('pay to name mismatch') || lowerNote.includes('no matching contract found') || lowerNote.includes('issue while getting contract') || lowerNote.includes('hold for payer review')) return 'PV';
            if (lowerNote.includes('part b outpatient claim to be priced at line level') || lowerNote.includes('part a inpatient claim to be priced at claim level') || lowerNote.includes('professional duplicate service') || (lowerNote.includes('w9 req') && lowerNote.includes('due')) || (lowerNote.includes('w9') && lowerNote.includes('received') && lowerNote.includes('pv updated')) || lowerNote.includes('payment>') || lowerNote.includes('exceeds total payment') || lowerNote.includes('net pay >') || lowerNote.includes('$10,000') || lowerNote.includes('$10000') || lowerNote.includes('pv updated') || lowerNote.includes('rerun rule') || lowerNote.includes('rerun') || lowerNote.includes('remap')) return 'Claims';
            return '';
        }

        function displayAssignmentTable(mgmtRows, notesIndex) {
            const tableBody = document.getElementById('assignment-table-body');
            tableBody.innerHTML = '';

            const notesSummary = new Map();
            mgmtRows.forEach(row => {
                const noteText = String(row[notesIndex] || '').trim();
                if (noteText === '') return;
                if (!notesSummary.has(noteText)) {
                    notesSummary.set(noteText, { count: 0 });
                }
                notesSummary.get(noteText).count++;
            });
            
            const sortedNotes = [...notesSummary.entries()].sort((a, b) => b[1].count - a[1].count);

            sortedNotes.forEach(([noteText, data]) => {
                const preAssigned = autoAssignOwner(noteText);
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-700 align-top break-words max-w-lg">${noteText}</td><td class="px-6 py-4 text-sm text-gray-700 align-top">${data.count}</td><td class="px-6 py-4 text-sm text-gray-700 align-top"><input type="text" class="table-input" data-note="${noteText.replace(/"/g, '&quot;')}" value="${preAssigned}"></td>`;
                tableBody.appendChild(row);
            });
            
            document.getElementById('mgmt-review-assignment-container').classList.remove('hidden');
        }

        function resetUI() {
            displayStatus('', 'info', false);
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('mgmt-review-assignment-container').classList.add('hidden');
            document.getElementById('download-links').innerHTML = '';
            document.getElementById('copy-email-container').innerHTML = '';
            document.getElementById('process-btn-container').classList.remove('hidden');
            // Reset global data
            triagedPrebatchRows = []; triagedMainReportRows = []; triagedMgmtReviewRows = [];
            reportHeader = []; finalNotesIndexForMgmtReview = -1;
        }

        function createDownloadLink(data, fileName, mimeType, label) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.className = 'inline-block bg-green-600 text-white font-bold text-lg rounded-lg py-3 px-10 hover:bg-green-700';
            link.textContent = `Download ${label}`;
            document.getElementById('download-links').appendChild(link);
        }

        function displayStatus(message, type, showLoader = false) {
            document.getElementById('results-container').classList.remove('hidden');
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : '#4f46e5');
            document.getElementById('loader').style.display = showLoader ? 'block' : 'none';
        }

        // --- Other Helpers (Unchanged) ---
        const getStatsForAOA = (aoa, cfg) => { /* ... Full function definition ... */ return {}; };
        const copyEmailText = () => { /* ... Full function definition ... */ };
        const getFormattedDate = () => { const d=new Date(), day=d.getDate(), month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()], year=d.getFullYear(); const s = (day%10===1&&day!==11)?'st':((day%10===2&&day!==12)?'nd':((day%10===3&&day!==13)?'rd':'th')); return `${day}${s} ${month} ${year}`; };
        const extractDueDateFromNote = (noteText) => { const match = (noteText || '').match(/due\s*(by)?[:\s]*(\d{1,2}[\/-]\d{1,2}(?:[\/-]\d{2,4})?)/i); return match ? match[2] : ''; };
        const parseCurrency = (value) => (value === null || value === undefined) ? NaN : parseFloat(String(value).replace(/[^0-9.-]/g, '')) || NaN;
        const truncateSheetName = (name) => name.replace(/[\\\/\?\*\[\]]/g, '').substring(0, 31);

        document.addEventListener('DOMContentLoaded', initializeTool);
    </script>

</body>
</html>
